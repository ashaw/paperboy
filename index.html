<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>paperboy.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>paperboy.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;erb&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;open-uri&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;chartbeat&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;stats_combiner/filterer&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;hashie&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p> <strong>Paperboy</strong> is a chartbeat-based library for creating
 HTML files showcasing from your most popular stories
 over the course of a time period (perhaps for a daily newsletter).
 It sniffs out META tags from URLs to build images and blurbs for the page.
 Paperboy builds on concepts from <a href="http://github.com/tpm/stats_combiner">stats_combiner.gem</a> but relies on chartbeat&rsquo;s
 historical <a href="http://chartbeat.pbworks.com/snapshots">snapshots</a> endpoint, where stats_combiner uses real-time data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">Paperboy</span>
  </pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p> <code>Paperboy::Collector</code> queries the chartbeat API&rsquo;s snapshots method
 and consolidates visitors over the specified timespan.
 Then it pushes out barebones HTML to be gussied-up.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">class</span> <span class="nc">Collector</span>
        
    <span class="kp">attr_accessor</span> <span class="ss">:outfile</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p> Initialize a <code>Paperboy</code> instance. This script is relatively expensive, and
 is ideally run on a cron, perhaps once a day. Unlike stats_combiner, Paperboy uses
 historical data, so it really doesn&rsquo;t matter <em>when</em> you set this to run, as long as you&rsquo;re
 grabbing relative timestamps.</p>

<p> API key and host come from your Chartbeat settings.
 Start and end times are UNIX timestamps. Paperboy will  collect hourly between them.
 It defaults to yesterday from midnight to midnight.
 Filters is an instance of <code>StatsCombiner::Filterer</code>. To use it, first
 instantiate a Filterer object with:</p>

<pre><code>e = StatsCombiner::Filterer.new
</code></pre>

<p> then add filter rules such as</p>

<pre><code>e.add { 
  :prefix =&gt; 'tpmdc', 
  :title_regex =&gt; /\| TPMDC/, 
  :modify_title =&gt; true
}
</code></pre>

<p> finally, pass <code>e.filters</code> to this method.</p>

<p> <code>img_xpath</code> and <code>blurb_xpath</code> are xpath queries that will run on the URL extracted
 from chartbeat (and any filters run on it) to populate your email with data that might
 reside in META tags. Here some I&rsquo;ve found useful. <code>*_xpath</code> takes the <code>content</code> attribute
 of whatever HEAD tag is queried.</p>

<pre><code> :img_xpath =&gt; '//head/meta[@property="og:image"]',
 :blurb_xpath =&gt; '//head/meta[@name="description"]'
</code></pre>

<p> Another option is <code>:interval</code>, which determines the interval of snapshots it takes before
 <code>start_time</code> and <code>end_time</code>. The default is 3600 seconds, or one hour.</p>

<p> Usage example:</p>

<pre><code> p = Paperboy::Collector.new {
  :api_key =&gt; 'chartbeat_api_key',  
  :host =&gt; 'yourdomain.com',
  :start_time =&gt; 1277784000
  :end_time =&gt; 1277870399,
  :interval =&gt; 3600,
  :filters =&gt; e.filters,
  :img_xpath =&gt; '//head/meta[@property="og:image"]',
  :blurb_xpath =&gt; '//head/meta[@name="description"]'
  }
</code></pre>

<p> The static file generated by Paperboy will be called &ldquo;yourdomain.com_paperboy_output.html.&rdquo;
 Change this with <code>p.outfile</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">opts</span> <span class="o">=</span> <span class="p">{})</span>
      <span class="vi">@opts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">:apikey</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
        <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
        <span class="ss">:start_time</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span> <span class="o">-</span> <span class="mi">18000</span><span class="p">,</span> <span class="c1">#four hour default window</span>
        <span class="ss">:end_time</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">,</span>
        <span class="ss">:interval</span> <span class="o">=&gt;</span> <span class="mi">3600</span><span class="p">,</span>
        <span class="ss">:filters</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
        <span class="ss">:img_xpath</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
        <span class="ss">:blurb_xpath</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
      <span class="p">}</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:apikey</span><span class="o">].</span><span class="n">nil?</span> <span class="o">||</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:host</span><span class="o">].</span><span class="n">nil?</span>
        <span class="k">raise</span> <span class="no">Paperboy</span><span class="o">::</span><span class="no">Error</span><span class="p">,</span> <span class="s2">&quot;No Chartbeat API Key or Host Specified!&quot;</span>
      <span class="k">end</span>
      
      <span class="vi">@c</span> <span class="o">=</span> <span class="no">Chartbeat</span><span class="o">.</span><span class="n">new</span> <span class="ss">:apikey</span> <span class="o">=&gt;</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:apikey</span><span class="o">]</span><span class="p">,</span> <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span>
      <span class="vi">@outfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@opts</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span><span class="si">}</span><span class="s2">_paperboy_output.html&quot;</span>
      
      <span class="vi">@stories</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="vi">@uniq_stories</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p> <strong>Run</strong> runs the collector according to parameters set up in <code>new</code>.
 By default, it will generate an HTML file in the current directory with a
 standard bare-bones structure. There is also an option to pass data through an
 ERB template. That is done like so:</p>

<pre><code>p.run :via =&gt; 'erb', :template =&gt; '/path/to/tmpl.erb'
</code></pre>

<p> ERB templates will expect to iterate over a <code>@stories</code> array, where each item is
 a hash of story attributes. See Paperboy::View#erb below for more on templating.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">opts</span> <span class="o">=</span> <span class="p">{})</span>
      <span class="vi">@run_opts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">:via</span> <span class="o">=&gt;</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span>
        <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
      <span class="p">}</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
      
      <span class="n">result</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">collect_stories</span>      
      <span class="n">v</span> <span class="o">=</span> <span class="no">Paperboy</span><span class="o">::</span><span class="no">View</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="vi">@outfile</span><span class="p">)</span>
        
      <span class="k">if</span> <span class="vi">@run_opts</span><span class="o">[</span><span class="ss">:via</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;erb&#39;</span>
        <span class="k">if</span> <span class="vi">@run_opts</span><span class="o">[</span><span class="ss">:template</span><span class="o">].</span><span class="n">nil?</span>
          <span class="k">raise</span> <span class="no">Paperboy</span><span class="o">::</span><span class="no">Error</span><span class="p">,</span> <span class="s2">&quot;A template file must be specified with the erb option.&quot;</span>
        <span class="k">end</span>
        <span class="n">v</span><span class="o">.</span><span class="n">erb</span><span class="p">(</span><span class="vi">@run_opts</span><span class="o">[</span><span class="ss">:template</span><span class="o">]</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">v</span><span class="o">.</span><span class="n">html</span>
      <span class="k">end</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p> Determine if there is an outfile for this instance. If so, get the filename.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">outfile</span>
      <span class="n">f</span> <span class="o">=</span> <span class="vi">@outfile</span>
      <span class="k">if</span> <span class="no">File</span><span class="o">::</span><span class="n">exists?</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nb">puts</span> <span class="n">f</span>
      <span class="k">else</span>
        <span class="k">raise</span> <span class="no">Paperboy</span><span class="o">::</span><span class="no">Error</span><span class="p">,</span> <span class="s2">&quot;No result file: </span><span class="si">#{</span><span class="n">f</span><span class="si">}</span><span class="s2"> Try calling `run` first in this directory&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p> Get the contents of the HTML file. I.e. the final product of the Paperboy run.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">html</span>
      <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="vi">@outfile</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <h3>Internals</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre>    
    <span class="kp">protected</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p> Find out how many times we&rsquo;ll have to query the Chartbeat API.
 We&rsquo;ll only do it once per <code>@opts[:interval]</code> between start and end times.
 By default, the interval is 3600 seconds.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">get_collection_intervals</span>  
      <span class="n">times</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">i</span> <span class="o">=</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:start_time</span><span class="o">]</span>
      <span class="kp">loop</span> <span class="k">do</span>        
        <span class="n">times</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:interval</span><span class="o">]</span>
        <span class="k">break</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:end_time</span><span class="o">]</span> <span class="o">||</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:end_time</span><span class="o">]</span> <span class="o">-</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:start_time</span><span class="o">]</span> <span class="o">&lt;</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:interval</span><span class="o">]</span>
      <span class="k">end</span>
      <span class="n">times</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p> Query the chartbeat API via the chartbeat gem, and organize
 stories over the course of the day into a big array.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">collect_stories</span>
      <span class="n">times</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">get_collection_intervals</span>
      
      <span class="n">times</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">time</span><span class="o">|</span>
        <span class="nb">puts</span> <span class="s2">&quot;Collecting for </span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2">...&quot;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="no">Hashie</span><span class="o">::</span><span class="no">Mash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@c</span><span class="o">.</span><span class="n">snapshots</span><span class="p">(</span><span class="ss">:timestamp</span> <span class="o">=&gt;</span> <span class="n">time</span><span class="p">))</span>
        
        <span class="n">titles</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">titles</span><span class="o">.</span><span class="n">to_a</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">active</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">titles</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">paths</span><span class="o">.</span><span class="n">nil?</span>
          <span class="n">paths_visitors</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span><span class="o">|</span><span class="n">q</span><span class="o">|</span> <span class="o">[</span><span class="n">q</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">q</span><span class="o">.</span><span class="n">total</span><span class="o">]</span><span class="p">}</span> 
          </pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p> Match titles to paths and add visitors.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="n">titles</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">title</span><span class="o">|</span>
            <span class="n">paths_visitors</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">path_visitor</span><span class="o">|</span>
              <span class="k">if</span> <span class="n">path_visitor</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">title</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
                <span class="n">title</span> <span class="o">&lt;&lt;</span> <span class="n">path_visitor</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
              <span class="k">end</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">else</span>
          <span class="nb">warn</span> <span class="s2">&quot;Warning! No data collected for </span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2">. Results may be skewed! Try setting older timestamps for best results.&quot;</span>
        <span class="k">end</span>
        
        <span class="vi">@stories</span> <span class="o">&lt;&lt;</span> <span class="n">titles</span>
      <span class="k">end</span>
      
      <span class="nb">self</span><span class="o">.</span><span class="n">package_stories</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p> If filters are enabled, run each story through the Filterer,
 and modify URL and Title as necessary</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">filter_story</span><span class="p">(</span><span class="n">hed</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
      <span class="n">filters</span> <span class="o">=</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:filters</span><span class="o">]</span>
      <span class="n">d</span> <span class="o">=</span> <span class="no">StatsCombiner</span><span class="o">::</span><span class="no">Filterer</span><span class="o">.</span><span class="n">apply_filters!</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:filters</span><span class="o">]</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">hed</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="n">path</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">[</span><span class="ss">:prefix</span><span class="o">].</span><span class="n">nil?</span>
          <span class="n">d</span><span class="o">[</span><span class="ss">:prefix</span><span class="o">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">[</span><span class="ss">:prefix</span><span class="o">]</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
      <span class="k">end</span>       
      <span class="n">d</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">d</span><span class="o">[</span><span class="ss">:prefix</span><span class="o">]</span><span class="si">}#{</span><span class="vi">@opts</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span><span class="si">}#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">d</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p> Find out if we need to filter the stories, and send to <code>filter_story</code> if so.
 Otherwise, weed out the dupes and get ready to package into something we can use.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">prepackage_stories</span>
      <span class="vi">@stories</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">hour</span><span class="o">|</span>
        <span class="n">hour</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">datum</span><span class="o">|</span>
          <span class="n">path</span> <span class="o">=</span> <span class="n">datum</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">dup</span>
          <span class="n">hed</span> <span class="o">=</span> <span class="n">datum</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">dup</span>
          <span class="n">visitors</span> <span class="o">=</span> <span class="n">datum</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">||</span> <span class="mi">0</span>
          
          <span class="k">if</span> <span class="vi">@opts</span><span class="o">[</span><span class="ss">:filters</span><span class="o">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">filter_story</span><span class="p">(</span><span class="n">hed</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
            <span class="n">hed</span> <span class="o">=</span> <span class="n">d</span><span class="o">[</span><span class="ss">:title</span><span class="o">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">d</span><span class="o">[</span><span class="ss">:path</span><span class="o">]</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">d</span><span class="o">[</span><span class="ss">:url</span><span class="o">]</span>
          <span class="k">else</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="vi">@opts</span><span class="o">[</span><span class="ss">:host</span><span class="o">]</span><span class="si">}#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">end</span>
                    
          <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">nil?</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="vi">@uniq_stories</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span><span class="o">|</span><span class="n">q</span><span class="o">|</span> <span class="n">q</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">hed</span><span class="p">)</span>
              <span class="vi">@uniq_stories</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">url</span><span class="p">,</span><span class="n">hed</span><span class="p">,</span><span class="n">visitors</span><span class="o">]</span>
            <span class="k">else</span>
              <span class="n">dupe_idx</span> <span class="o">=</span> <span class="vi">@uniq_stories</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">q</span><span class="o">|</span> <span class="n">q</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">}</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">hed</span><span class="p">)</span>
              <span class="vi">@uniq_stories</span><span class="o">[</span><span class="n">dupe_idx</span><span class="o">][</span><span class="mi">2</span><span class="o">]</span> <span class="o">+=</span> <span class="n">visitors</span>
            <span class="k">end</span>      
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>        
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p> First, send stories to be prepackaged. Then, sort them by visitors,
 and start looking for blurbs and images out on the URLs themselves for the top ten.
 At some point, it might be a good idea to make the number collected an option.
 Finally, generate the HTML and save as a static file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">package_stories</span>
      
      <span class="nb">self</span><span class="o">.</span><span class="n">prepackage_stories</span>
      
      <span class="n">uniq_stories</span> <span class="o">=</span> <span class="vi">@uniq_stories</span><span class="o">.</span><span class="n">sort</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">|</span> <span class="n">b</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">&lt;=&gt;</span> <span class="n">a</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">}</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">9</span><span class="o">]</span>
      
      <span class="n">story_pkgs</span> <span class="o">=</span> <span class="o">[]</span>
      
      <span class="n">uniq_stories</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">story</span><span class="o">|</span>
        <span class="n">story_pkg</span> <span class="o">=</span> <span class="o">[]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">story</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
        <span class="n">hed</span> <span class="o">=</span> <span class="n">story</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
        <span class="n">visitors</span> <span class="o">=</span> <span class="n">story</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
        
        <span class="k">begin</span>
          <span class="n">d</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
          <span class="k">rescue</span> <span class="no">OpenURI</span><span class="o">::</span><span class="no">HTTPError</span> <span class="o">||</span> <span class="no">Timeout</span><span class="o">::</span><span class="no">Error</span>
            <span class="n">d</span> <span class="o">=</span> <span class="kp">nil</span>
        <span class="k">end</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p> Only grab metadata and add this story to the stories array
 if it&rsquo;s reachable. Otherwise, we&rsquo;ll assume it&rsquo;s a dead link and skip it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">nil?</span>
          <span class="n">description</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="vi">@opts</span><span class="o">[</span><span class="ss">:blurb_xpath</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">rescue</span> <span class="kp">nil</span>
          <span class="n">img</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="vi">@opts</span><span class="o">[</span><span class="ss">:img_xpath</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">rescue</span> <span class="kp">nil</span>
        
          <span class="n">story_pkg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">,</span>
            <span class="ss">:hed</span> <span class="o">=&gt;</span> <span class="n">hed</span><span class="p">,</span>
            <span class="ss">:visitors</span> <span class="o">=&gt;</span> <span class="n">visitors</span><span class="p">,</span>
            <span class="ss">:blurb</span> <span class="o">=&gt;</span> <span class="n">description</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="ss">:img</span> <span class="o">=&gt;</span> <span class="n">img</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span>
          <span class="p">}</span>
          <span class="n">story_pkgs</span> <span class="o">&lt;&lt;</span> <span class="n">story_pkg</span>
        <span class="k">end</span>      
      
      <span class="k">end</span>
      
      <span class="n">story_pkgs</span>
    <span class="k">end</span>
  
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <h3>Templating Paperboy</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p> <strong>Paperboy::View</strong> is for templating Paperboy output.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">class</span> <span class="nc">View</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p> Views are initialized from the <code>run</code> method of <code>PaperBoy::Collector</code>
 but can also be invoked separately, if you have an array of stories.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">story_pkgs</span><span class="p">,</span><span class="n">outfile</span><span class="p">)</span>
      <span class="vi">@stories</span> <span class="o">=</span> <span class="n">story_pkgs</span>
      <span class="vi">@outfile</span> <span class="o">=</span> <span class="n">outfile</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p> HTML is the default output method. It will return a bare-bones
 page of story output including blurbs and images if available.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">html</span>

      <span class="n">html</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
      
      <span class="vi">@stories</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pkg</span><span class="o">|</span>
      
        <span class="n">html</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="no">DOCUMENT</span>
<span class="sh">        &lt;div class=&quot;story&quot;&gt;</span>
<span class="sh">          &lt;h2&gt;&lt;a href=&quot;#{pkg[:url]}&quot;&gt;#{pkg[:hed]}&lt;/a&gt;&lt;/h2&gt;</span>
<span class="no">DOCUMENT</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">[</span><span class="ss">:img</span><span class="o">].</span><span class="n">empty?</span>
          <span class="n">html</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="no">DOCUMENT</span>
<span class="sh">          &lt;div class=&quot;img&quot;&gt;&lt;a href=&quot;#{pkg[:url]}&quot;&gt;&lt;img src=&quot;#{pkg[:img]}&quot;&gt;&lt;/a&gt;&lt;/div&gt;</span>
<span class="no">DOCUMENT</span>
        <span class="k">end</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pkg</span><span class="o">[</span><span class="ss">:blurb</span><span class="o">].</span><span class="n">empty?</span>
          <span class="n">html</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="no">DOCUMENT</span>
<span class="sh">          &lt;div class=&quot;blurb&quot;&gt;#{pkg[:blurb]}&lt;/div&gt;</span>
<span class="no">DOCUMENT</span>
        <span class="k">end</span>
        
        <span class="n">html</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;&lt;</span><span class="no">DOCUMENT</span>
<span class="sh">        &lt;/div&gt;</span>
<span class="no">DOCUMENT</span>
      
      <span class="k">end</span>
      
      <span class="nb">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p> Templatize your story output with embedded ruby.
 This allows the greatest flexibility for presenting the data.</p>

<p> To use, access the <code>@stories</code> array, and it&rsquo;s component hashes.
 Example:</p>

<pre><code>&lt;h1&gt;My Popular Stories&lt;/h1&gt;

  &lt;% @stories.each do |story| %&gt;
    &lt;div class="story"&gt;
       &lt;h2&gt;&lt;a href="&lt;%= story[:url] %&gt;"&gt;&lt;%= story[:hed] %&gt;&lt;/a&gt;&lt;/h2&gt;
       &lt;% if not story[:img].empty? %&gt;
         &lt;div class="img"&gt;
            &lt;a href="&lt;%= story[:url] %&gt;"&gt;
             &lt;img src="&lt;%= story[:img] %&gt;"&gt;
            &lt;/a&gt;
         &lt;/div&gt;
       &lt;% end %&gt;
       &lt;% if not story[:blurb].empty? %&gt;
         &lt;div class="blurb"&gt;&lt;%= story[:blurb] %&gt;&lt;/div&gt;
       &lt;% end %&gt;
    &lt;/div&gt;
  &lt;% end %&gt;
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">erb</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
      <span class="n">t</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
      <span class="n">template</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">to_s</span>      
      <span class="n">html</span> <span class="o">=</span> <span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
      
      <span class="nb">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">end</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <p> Write out flat HTML to a file from either plain html or erb templating.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
      <span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@outfile</span><span class="p">,</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span>      
      <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
      <span class="n">f</span><span class="o">.</span><span class="n">close</span>
    <span class="k">end</span>
  
  <span class="k">end</span>

<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paperboy</span><span class="o">::</span><span class="no">Error</span> <span class="o">&lt;</span> <span class="no">StandardError</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    </table>
</div>
</body>
